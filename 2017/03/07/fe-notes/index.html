<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 前端开发大纲 · TFBoys' Playground</title><meta name="description" content="前端开发大纲 - TapasFE"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="https://github.com/TapasFE" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">前端开发大纲</h1><div class="post-meta"><div class="post-time">2017年3月7日</div></div><div class="post-content"><h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><p>为了更好地协作，项目结构最好统一起来。一般可以包括如下目录结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">▸ dist/          # 纯静态编译后的代码</div><div class="line">▸ lib/           # 服务端可直接运行的代码，或作为依赖存在的代码</div><div class="line">▸ scripts/       # 辅助用的脚本，比如编译、部署、配置管理</div><div class="line">▸ src/           # 需要编译的源码，如ES6，JSX</div><div class="line">  .editorconfig</div><div class="line">  .gitignore</div><div class="line">  config.yml     # 存放一些敏感的配置，与nconf配合使用（见后）</div><div class="line">  process.yml    # PM2启动服务端用的配置文件</div><div class="line">  README.md      # 介绍项目的基本信息，和常用的命令，方便其他协作者上手</div></pre></td></tr></table></figure>
<p>注意事项：</p>
<ul>
<li>项目文件命名避免使用大写字母，最好使用全小写加连字符的形式，如<code>my-project</code>，以免在不同平台间出现问题。</li>
<li><code>config.yml</code>中的信息敏感，一定要记得将<code>config.yml</code>加入<code>.gitignore</code>，或者直接使用环境变量替代。</li>
</ul>
<h3 id="自动化脚本"><a href="#自动化脚本" class="headerlink" title="自动化脚本"></a>自动化脚本</h3><p>每个项目最好都可以通过最简单的命令来完成一些常用操作，如：</p>
<ul>
<li><code>npm run dev</code>：一键开发</li>
<li><code>npm run build</code>：一键编译</li>
<li><code>npm run deploy</code>：一键部署</li>
<li><code>npm start</code>：服务端项目一键启动</li>
</ul>
<p>然后通过<code>NODE_ENV</code>环境变量控制操作的类型，如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 编译用于测试环境</span></div><div class="line">$ npm run build</div><div class="line"></div><div class="line"><span class="comment"># 编译用于生产环境</span></div><div class="line">$ npm run build --production</div></pre></td></tr></table></figure>
<p>一键部署到生产环境需要慎重使用，避免误操作，可以加入显眼的提示和延时等。</p>
<h3 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h3><p>配置管理推荐使用<a href="https://github.com/indexzero/nconf" target="_blank" rel="external">nconf</a>，它是一个分层的配置管理工具，可以依次从每个层去查找相应的配置，轻松地实现配置的覆盖，而且支持<code>yaml</code>语法。</p>
<p>举个栗子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> nconf = <span class="built_in">require</span>(<span class="string">'nconf'</span>);</div><div class="line"></div><div class="line">nconf</div><div class="line"></div><div class="line"><span class="comment">// 如果需要强制覆盖一些配置，可以用overrides写到最前面一层</span></div><div class="line">.overrides(&#123;</div><div class="line">  <span class="attr">weather</span>: <span class="string">'sunny'</span>,</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// 从配置文件读取，如果文件不存在则忽略</span></div><div class="line">.file(&#123;</div><div class="line">  <span class="attr">file</span>: <span class="string">'config.yml'</span>,</div><div class="line">  <span class="attr">format</span>: <span class="built_in">require</span>(<span class="string">'nconf-yaml'</span>),    <span class="comment">// 如果不指定format则默认json</span></div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// 从环境变量读取</span></div><div class="line">.env()</div><div class="line"></div><div class="line"><span class="comment">// 从运行时传进来的参数读取</span></div><div class="line">.argv()</div><div class="line"></div><div class="line"><span class="comment">// 默认配置</span></div><div class="line">.defaults(&#123;</div><div class="line">  <span class="attr">weather</span>: <span class="string">'cloudy'</span>,</div><div class="line">  <span class="attr">NODE_ENV</span>: <span class="string">'development'</span>,</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// 还可以强行修改当前的配置，优先级最高</span></div><div class="line">nconf.set(<span class="string">'weather'</span>, <span class="string">'rainy'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 获取配置</span></div><div class="line"><span class="comment">// console.log(nconf.get('weather'));</span></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = nconf;</div></pre></td></tr></table></figure>
<p><code>nconf.get</code>会从每一层配置依次查找，返回第一个找到的结果。</p>
<p>在上面的例子中，<code>NODE_ENV</code>被默认设置为<code>development</code>，如果在环境变量中设置<code>NODE_ENV=production</code>，则<code>nconf.get(&#39;NODE_ENV&#39;) === &#39;production&#39;</code>，因为<code>.env()</code>这一层在<code>.defaults({...})</code>这一层的前面，会先被找到。</p>
<h3 id="Git的使用"><a href="#Git的使用" class="headerlink" title="Git的使用"></a>Git的使用</h3><ol>
<li>控制好提交的粒度，<a href="http://www.ruanyifeng.com/blog/2016/01/commit_message_change_log.html" target="_blank" rel="external">写好提交信息</a>，方便回滚。</li>
<li>打好标签（见后），方便回滚。</li>
<li>合并分支前先确保更新到最新状态，避免旧代码覆盖掉新代码，同时避免一个开发分支跨越主分支上很多提交、甚至版本号，方便回滚。</li>
<li>多人协作时，在不同分支上进行开发，避免在一个分支上修改另一个分支里开发的内容造成冲突。</li>
<li>分支命名最好让其他人一眼明白其用处，如<code>fix/awkward-bug</code>、<code>feature/awesome-feature</code>。</li>
</ol>
<h3 id="标签的使用"><a href="#标签的使用" class="headerlink" title="标签的使用"></a>标签的使用</h3><p>标签相当于一个不活跃的分支，其好处是一直存在，可以在需要的时候快速找到。</p>
<p>我们应该在每次部署是都打一个标签，这样如果之后出了问题，要回滚到上一个版本，只需要找到上一个版本对应的标签就好了。打标签可以使用命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm version [ patch | minor | major | &lt;version_number&gt; ]</div></pre></td></tr></table></figure>
<h3 id="服务端管理"><a href="#服务端管理" class="headerlink" title="服务端管理"></a>服务端管理</h3><ol>
<li><p>纯静态项目</p>
<p>纯静态项目最好的方案是部署到CDN上，但是有时候涉及缓存，或者是URL地址的原因，我们会在自己的服务器上来serve。最理想的方案是用nginx直接指向静态文件夹。</p>
<ul>
<li><p>生产环境：nginx直接serve静态文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">  listen 4000;</div><div class="line">  server_name single.dog;</div><div class="line"></div><div class="line">  location / &#123;</div><div class="line">    root /home/hugo/web/single_dog;</div><div class="line"></div><div class="line">    # 如果是单页面应用还需加上</div><div class="line">    try_files $uri /index.html;</div><div class="line">    add_header Cache-Control no-cache;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果配置好后任何地址都出现500，则多半是nginx没有权限访问静态文件夹（可以通过查看日志明确），可以通过以下命令验证：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo -u nginx <span class="built_in">stat</span> /home/hugo/web/single_dog</div><div class="line"><span class="comment"># 出错则说明没有权限</span></div></pre></td></tr></table></figure>
<p>添加权限的时候，需要给目标目录及其所有上级目录都加上其他用户（Other）的执行权限（x）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo chmod o+x /home /home/hugo /home/hugo/web /home/hugo/web/single_dog</div></pre></td></tr></table></figure>
</li>
<li><p>测试环境：可以用nginx，也可以用<a href="https://github.com/gera2ld/spa-static" target="_blank" rel="external">spa-static</a></p>
</li>
</ul>
</li>
<li><p>Node.js服务项目</p>
<p>项目通过<code>process.yml</code>配置好以后，直接用<a href="http://pm2.keymetrics.io/" target="_blank" rel="external">PM2</a>管理。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启动项目</span></div><div class="line">$ pm2 start process.yml</div><div class="line"></div><div class="line"><span class="comment"># 重启项目</span></div><div class="line">$ pm2 restart process.yml</div><div class="line"></div><div class="line"><span class="comment"># 列出所有项目</span></div><div class="line">$ pm2 ls</div><div class="line"></div><div class="line"><span class="comment"># 查看日志</span></div><div class="line">$ pm2 logs &lt;id_or_name&gt;</div></pre></td></tr></table></figure>
<p>注：启动项目后请一定查看日志或者项目状态，确定项目正常运行。</p>
</li>
</ol>
</div></article></div></section><footer><div class="paginator"><a href="/2017/03/10/how-to-write-blog/" class="prev">上一篇</a><a href="/2016/09/14/lets-encrypt/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2017 <a href="http://tapasfe.github.io">TapasFE</a>, <a href="https://hexo.io/">Hexo</a> with <a href="https://github.com/pinggod/hexo-theme-apollo">apollo</a>.</p></div></footer><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>